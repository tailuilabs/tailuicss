{"version":3,"sources":["../../src/postcss/index.ts","../../src/config.ts"],"sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport postcss, { PluginCreator, Root, AtRule } from 'postcss';\nimport { resolveConfig, PluginOptions } from '../config';\n\n/**\n * TailUI PostCSS Plugin (Zero-Config)\n *\n * Two jobs:\n * 1. Auto-injects all ui.*.css component styles before @tailwind components\n *    so the dev never has to manage CSS import order manually.\n * 2. Processes @style { ... } blocks in ui.*.css files.\n *\n * Resolves the styles directory from ui.config.json automatically.\n * The dev's CSS file just needs:\n *   @tailwind base;\n *   @tailwind components;\n *   @tailwind utilities;\n *\n * Usage in postcss.config.js:\n *   plugins: { '@tailuicss/core/postcss': {}, tailwindcss: {} }\n */\nconst tailuiPostcss: PluginCreator<PluginOptions> = (options: PluginOptions = {}) => {\n  const { stylesDir } = resolveConfig(options);\n\n  return {\n    postcssPlugin: 'tailuicss',\n\n    // We use Once with the second argument { result } to manage dependencies\n    Once(root: Root, { result }) {\n      // Resolving the absolute path to the styles directory\n      const fullPath = path.resolve(process.cwd(), stylesDir);\n\n      if (!fs.existsSync(fullPath)) {\n        return;\n      }\n\n\n      // This allows the detection of the addition or deletion of ui.*.css files.\n      result.messages.push({\n        type: 'dir-dependency',\n        dir: fullPath,\n        parent: root.source?.input.file\n      });\n\n      // Collecting ui.*.css files\n      const files = fs.readdirSync(fullPath)\n        .filter(f => f.startsWith('ui.') && f.endsWith('.css'))\n        .sort();\n\n      if (files.length === 0) return;\n\n      // Reading and saving each file as an individual dependency\n      let allCSS = files\n        .map(file => {\n          const filePath = path.join(fullPath, file);\n\n          // SIGNAL HMR: It is indicated that this specific file should be monitored\n          // Without this, modifying the library's CSS will not trigger a refresh\n          result.messages.push({\n            type: 'dependency',\n            file: filePath,\n            parent: root.source?.input.file\n          });\n\n          return fs.readFileSync(filePath, 'utf8');\n        })\n        .join('\\n');\n\n      // Block processing @style (supports nested curly braces)\n      allCSS = processStyleBlocks(allCSS);\n\n      // Combined CSS parsing\n      const parsed = postcss.parse(allCSS);\n\n      // Searching for the @tailwind components directive\n      let componentsRule: AtRule | null = null;\n      root.walkAtRules('tailwind', (atRule) => {\n        if (atRule.params === 'components') {\n          componentsRule = atRule;\n        }\n      });\n\n      if (componentsRule) {\n        // Front injection @tailwind components\n        parsed.nodes.slice().reverse().forEach(node => {\n          (componentsRule as AtRule).before(node.clone());\n        });\n        \n        // Discrete log in development to confirm the injection\n        if (process.env.NODE_ENV !== 'production') {\n          console.log(`[TailUI] ☑️ Injected ${files.length} component(s) with HMR enabled.`);\n        }\n      } else {\n        console.warn(`[TailUI] ⚠️  No \"@tailwind components\" directive found. Styles were not injected.`);\n      }\n    },\n  };\n};\n\ntailuiPostcss.postcss = true;\n\nexport default tailuiPostcss;\n\n/**\n * Process @style { ... } blocks, supporting nested braces.\n * Extracts the inner content and replaces the @style wrapper.\n */\nfunction processStyleBlocks(css: string): string {\n  let result = '';\n  let i = 0;\n\n  while (i < css.length) {\n    const idx = css.indexOf('@style', i);\n    if (idx === -1) {\n      result += css.slice(i);\n      break;\n    }\n\n    result += css.slice(i, idx);\n\n    const braceStart = css.indexOf('{', idx);\n    if (braceStart === -1) {\n      result += css.slice(idx);\n      break;\n    }\n\n    let depth = 1;\n    let j = braceStart + 1;\n    while (j < css.length && depth > 0) {\n      if (css[j] === '{') depth++;\n      else if (css[j] === '}') depth--;\n      j++;\n    }\n\n    const inner = css.slice(braceStart + 1, j - 1).trim();\n    result += inner;\n    i = j;\n  }\n\n  return result;\n}","import fs from 'fs';\nimport path from 'path';\n\nexport const CONFIG_FILE = 'ui.config.json';\nexport const DEFAULT_DIR = 'ui';\n\nexport interface PluginOptions {\n  path?: string;\n  [key: string]: unknown;\n}\n\nexport interface TailUIConfig {\n  stylesDir?: string;\n  [key: string]: unknown;\n}\n\nexport interface ResolvedConfig {\n  stylesDir: string;\n  configPath: string;\n  config: TailUIConfig | null;\n}\n\n/**\n * Resolve the TailUI styles directory.\n *\n * Priority:\n *   1. Explicit `options.path` (from plugin config)\n *   2. `stylesDir` from ui.config.json\n *   3. Default: ./ui/styles\n */\nexport function resolveConfig(options: PluginOptions = {}): ResolvedConfig {\n  const configPath = path.join(process.cwd(), CONFIG_FILE);\n  let config: TailUIConfig | null = null;\n\n  if (fs.existsSync(configPath)) {\n    try {\n      config = JSON.parse(fs.readFileSync(configPath, 'utf8')) as TailUIConfig;\n    } catch (e) {\n      console.warn(`[TailUI] ⚠️  Failed to parse ${CONFIG_FILE}: ${(e as Error).message}`);\n    }\n  }\n\n  let stylesDir: string;\n  if (options.path) {\n    stylesDir = options.path;\n  } else if (config?.stylesDir) {\n    stylesDir = config.stylesDir;\n  } else {\n    stylesDir = `./${DEFAULT_DIR}/styles`;\n  }\n\n  const resolved = path.resolve(process.cwd(), stylesDir);\n  if (!resolved.startsWith(process.cwd())) {\n    console.warn(`[TailUI] ⚠️  stylesDir \"${stylesDir}\" resolves outside the project. Using default.`);\n    stylesDir = `./${DEFAULT_DIR}/styles`;\n  }\n\n  return { stylesDir, configPath, config };\n}"],"mappings":"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","names":["fs","path","path","fs"]}